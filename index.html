<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise MSSP SOC Platform - XSIAM Integration</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #0066cc; --secondary: #004080; --success: #28a745;
            --warning: #ffc107; --danger: #dc3545; --info: #17a2b8;
            --dark-bg: #1a1a2e; --card-bg: #16213e; --text-primary: #ffffff;
            --text-secondary: #b8b8b8; --border: #2d3748;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--text-primary); line-height: 1.6; min-height: 100vh;
        }
        
        .container { max-width: 1900px; margin: 0 auto; padding: 15px; }
        
        header {
            background: var(--card-bg); padding: 15px 20px; border-radius: 8px;
            margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border-left: 4px solid var(--primary); display: flex;
            justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
        }
        
        header h1 { font-size: 20px; color: var(--primary); }
        header p { font-size: 11px; color: var(--text-secondary); margin-top: 3px; }
        
        .tenant-controls {
            display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
        }
        
        .tenant-controls select {
            padding: 8px 12px; background: var(--dark-bg);
            border: 2px solid var(--border); border-radius: 6px;
            color: var(--text-primary); font-size: 13px; min-width: 180px;
        }
        
        .toggle-switch {
            position: relative; display: inline-block; width: 50px; height: 24px;
        }
        
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 24px;
        }
        
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px;
            left: 3px; bottom: 3px; background-color: white;
            transition: .4s; border-radius: 50%;
        }
        
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        .sync-controls {
            background: var(--card-bg); padding: 15px 20px; border-radius: 8px;
            margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 20px; flex-wrap: wrap;
            border-left: 4px solid var(--success);
        }
        
        .sync-status { display: flex; align-items: center; gap: 10px; }
        
        .sync-indicator {
            width: 12px; height: 12px; border-radius: 50%;
            background: var(--success); animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .sync-indicator.inactive { background: var(--danger); animation: none; }
        
        .tabs { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        
        .tab-button {
            padding: 8px 16px; background: var(--card-bg);
            border: 2px solid var(--border); color: var(--text-primary);
            cursor: pointer; border-radius: 6px; font-size: 12px;
            font-weight: 600; transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            background: var(--primary); border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .tab-button.active {
            background: var(--primary); border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,102,204,0.4);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px; margin-bottom: 15px;
        }
        
        .widget {
            background: var(--card-bg); padding: 18px; border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border-left: 4px solid var(--primary); cursor: pointer;
            transition: all 0.3s ease; position: relative;
        }
        
        .widget:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }
        
        .widget h3 { font-size: 14px; margin-bottom: 12px; color: var(--primary); }
        .widget-value { font-size: 32px; font-weight: bold; margin-bottom: 8px; }
        .widget-label { font-size: 11px; color: var(--text-secondary); }
        
        .last-updated {
            position: absolute; top: 10px; right: 10px;
            font-size: 9px; color: var(--text-secondary);
            background: rgba(0,0,0,0.3); padding: 3px 8px; border-radius: 4px;
        }
        
        .severity-breakdown { display: flex; gap: 8px; margin-top: 12px; }
        
        .severity-item {
            flex: 1; text-align: center; padding: 8px;
            background: rgba(255,255,255,0.05); border-radius: 6px;
        }
        
        .severity-item .count { font-size: 20px; font-weight: bold; }
        .severity-item .label { font-size: 10px; margin-top: 4px; }
        
        .critical { color: #dc3545; }
        .high { color: #fd7e14; }
        .medium { color: #ffc107; }
        .low { color: #28a745; }
        
        .customer-card {
            background: var(--card-bg); padding: 18px; border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border-left: 4px solid var(--info); cursor: pointer;
            transition: all 0.3s ease; margin-bottom: 12px;
        }
        
        .customer-card:hover {
            transform: translateX(5px); border-left-color: var(--success);
        }
        
        .customer-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 12px;
        }
        
        .customer-name { font-size: 16px; font-weight: bold; }
        
        .status-badge {
            padding: 4px 10px; border-radius: 12px;
            font-size: 10px; font-weight: 600;
        }
        
        .status-active {
            background: rgba(40,167,69,0.2); color: var(--success);
            border: 1px solid var(--success);
        }
        
        .form-section {
            background: var(--card-bg); padding: 18px; border-radius: 8px;
            margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .form-section h3 {
            margin-bottom: 12px; color: var(--primary); font-size: 15px;
        }
        
        .btn {
            padding: 9px 20px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 12px; font-weight: 600;
            transition: all 0.3s ease; display: inline-flex;
            align-items: center; gap: 6px;
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-warning { background: var(--warning); color: #000; }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .button-group { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
        
        .alert {
            padding: 10px 15px; border-radius: 6px; margin-bottom: 12px;
            display: none; animation: slideIn 0.3s ease; font-size: 12px;
        }
        
        .alert.show { display: block; }
        .alert-success { background: rgba(40,167,69,0.2); border-left: 4px solid var(--success); }
        .alert-danger { background: rgba(220,53,69,0.2); border-left: 4px solid var(--danger); }
        .alert-info { background: rgba(23,162,184,0.2); border-left: 4px solid var(--info); }
        .alert-warning { background: rgba(255,193,7,0.2); border-left: 4px solid var(--warning); }
        
        .two-column { display: grid; grid-template-columns: 1fr 2fr; gap: 15px; }
        
        .incident-card {
            background: rgba(255,255,255,0.05); padding: 12px;
            margin-bottom: 10px; border-radius: 6px;
            border-left: 4px solid var(--info); cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .incident-card:hover {
            background: rgba(255,255,255,0.1); transform: translateX(5px);
        }
        
        .incident-card.selected {
            border-left-color: var(--success);
            background: rgba(40,167,69,0.1);
        }
        
        .loading-spinner {
            display: inline-block; width: 18px; height: 18px;
            border: 3px solid rgba(255,255,255,0.3); border-radius: 50%;
            border-top-color: var(--primary); animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .data-source-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; background: rgba(255,255,255,0.03);
            border-radius: 6px; margin-bottom: 6px; font-size: 12px;
        }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot.online { background: var(--success); }
        .status-dot.offline { background: var(--danger); }
        .status-dot.warning { background: var(--warning); }
        
        .kpi-card {
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(0,102,204,0.1) 100%);
            padding: 18px; border-radius: 8px; text-align: center;
            border: 2px solid var(--border);
        }
        
        .kpi-value {
            font-size: 36px; font-weight: bold; color: var(--primary);
            margin-bottom: 5px;
        }
        
        .kpi-label {
            font-size: 12px; color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        .kpi-trend { font-size: 11px; margin-top: 6px; }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }
        
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            z-index: 1000; align-items: center; justify-content: center;
            overflow-y: auto; padding: 20px;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: var(--card-bg); padding: 25px; border-radius: 10px;
            max-width: 1200px; width: 100%; max-height: 90vh;
            overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        
        .modal-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 20px;
            padding-bottom: 15px; border-bottom: 2px solid var(--border);
        }
        
        .modal-header h2 { color: var(--primary); font-size: 18px; }
        
        .close-btn {
            background: var(--danger); color: white; border: none;
            padding: 6px 12px; border-radius: 6px; cursor: pointer;
            font-size: 12px; font-weight: 600;
        }
        
        .preview-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #000; padding: 40px;
            border-radius: 12px; margin-top: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            border: 3px solid var(--primary);
        }
        
        .preview-header {
            text-align: center; margin-bottom: 30px;
            padding-bottom: 20px; border-bottom: 3px solid var(--primary);
        }
        
        .preview-header h1 {
            color: var(--primary); font-size: 28px; margin-bottom: 10px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        
        .executive-summary {
            background: linear-gradient(135deg, rgba(0,102,204,0.1) 0%, rgba(0,102,204,0.05) 100%);
            padding: 25px; border-radius: 10px; margin-bottom: 25px;
            border-left: 5px solid var(--primary);
        }
        
        .severity-indicator {
            display: inline-block; padding: 8px 20px; border-radius: 20px;
            font-weight: bold; font-size: 14px; text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .severity-critical {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white; box-shadow: 0 4px 12px rgba(220,53,69,0.4);
        }
        
        .info-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; margin: 20px 0;
        }
        
        .info-card {
            background: white; padding: 15px; border-radius: 8px;
            border: 2px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .info-card .label {
            font-size: 11px; color: #666; text-transform: uppercase;
            font-weight: 600; margin-bottom: 5px;
        }
        
        .info-card .value {
            font-size: 16px; color: #000; font-weight: bold;
        }
        
        .section-block {
            background: white; padding: 25px; border-radius: 10px;
            margin-bottom: 20px; border-left: 5px solid var(--info);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .section-block h3 {
            color: var(--secondary); font-size: 18px; margin-bottom: 15px;
        }
        
        .section-block p, .section-block ul {
            color: #333; font-size: 14px; line-height: 1.8;
        }
        
        .action-steps {
            counter-reset: step-counter;
            list-style: none; margin-left: 0;
        }
        
        .action-steps li {
            counter-increment: step-counter;
            margin-bottom: 15px; padding-left: 40px; position: relative;
        }
        
        .action-steps li:before {
            content: counter(step-counter);
            position: absolute; left: 0; top: 0;
            background: var(--primary); color: white;
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px;
        }
        
        .artifact-list {
            background: rgba(0,0,0,0.05); padding: 15px;
            border-radius: 8px; font-family: 'Courier New', monospace;
            font-size: 12px; margin-top: 10px;
        }
        
        .causality-chain {
            display: flex; align-items: center; gap: 10px;
            flex-wrap: wrap; margin: 15px 0;
        }
        
        .causality-step {
            background: linear-gradient(135deg, var(--info) 0%, rgba(23,162,184,0.8) 100%);
            color: white; padding: 10px 15px; border-radius: 8px;
            font-size: 12px; font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .causality-arrow {
            font-size: 20px; color: var(--primary); font-weight: bold;
        }
        
        @media (max-width: 1200px) {
            .two-column { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üõ°Ô∏è Enterprise MSSP SOC Platform</h1>
                <p>AI-Powered Threat Hunting | XSIAM Integration | Real-time Investigation | Executive Reporting</p>
            </div>
            <div class="tenant-controls">
                <label style="font-weight: 600; font-size: 12px;">Customer:</label>
                <select id="tenantSelector" onchange="switchTenant()">
                    <option value="atpl-nfr">üè¢ ATPL NFR (Default)</option>
                </select>
                <button class="btn btn-success" onclick="showOnboardModal()">‚ûï Onboard</button>
            </div>
        </header>

        <div id="alert-container"></div>

        <!-- Auto-Sync Controls -->
        <div class="sync-controls">
            <div class="sync-status">
                <div class="sync-indicator" id="syncIndicator"></div>
                <span style="font-weight: 600; font-size: 13px;">Auto-Sync:</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoSyncToggle" checked onchange="toggleAutoSync()">
                    <span class="slider"></span>
                </label>
                <span id="syncStatusText" style="font-size: 12px; color: var(--success);">Active</span>
            </div>
            
            <div style="display: flex; align-items: center; gap: 10px;">
                <label style="font-size: 12px; font-weight: 600;">Interval:</label>
                <select id="syncInterval" onchange="updateSyncInterval()" style="padding: 6px 10px; background: var(--dark-bg); border: 2px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px;">
                    <option value="10">10 seconds</option>
                    <option value="30" selected>30 seconds</option>
                    <option value="60">1 minute</option>
                    <option value="120">2 minutes</option>
                    <option value="300">5 minutes</option>
                </select>
            </div>
            
            <button class="btn btn-primary" onclick="fetchLiveCases()">üîÑ Fetch Live Cases</button>
            
            <div style="font-size: 11px; color: var(--text-secondary);">
                Last sync: <span id="lastSyncTime">Never</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('mssp-dashboard')">üåê MSSP Dashboard</button>
            <button class="tab-button" onclick="switchTab('ciso-dashboard')">üìä CISO Dashboard</button>
            <button class="tab-button" onclick="switchTab('analyst-view')">üë®‚Äçüíª Analyst Workspace</button>
            <button class="tab-button" onclick="switchTab('manager-view')">üëî SOC Manager</button>
            <button class="tab-button" onclick="switchTab('incidents')">üö® Incidents</button>
            <button class="tab-button" onclick="switchTab('threat-hunting')">üéØ Threat Hunting</button>
            <button class="tab-button" onclick="switchTab('investigation')">üî¨ Investigation</button>
            <button class="tab-button" onclick="switchTab('threat-intel')">üîç Threat Intel</button>
            <button class="tab-button" onclick="switchTab('cloud-command')">‚òÅÔ∏è Cloud Command</button>
            <button class="tab-button" onclick="switchTab('integrations')">üîå Integrations</button>
            <button class="tab-button" onclick="switchTab('customers')">üë• Customers</button>
        </div>

        <!-- MSSP Dashboard -->
        <div id="mssp-dashboard" class="tab-content active">
            <h2 style="margin-bottom: 15px; color: var(--primary); font-size: 18px;">Multi-Tenant Security Overview</h2>
            
            <div class="dashboard-grid">
                <div class="widget" onclick="switchTab('customers')">
                    <div class="last-updated" id="customersLastUpdate">Just now</div>
                    <h3>Total Customers</h3>
                    <div class="widget-value" id="totalCustomers">1</div>
                    <div class="widget-label">Active Tenants</div>
                </div>
                <div class="widget" onclick="switchTab('incidents')">
                    <div class="last-updated" id="incidentsLastUpdate">Not synced</div>
                    <h3>Total Incidents</h3>
                    <div class="widget-value" id="totalIncidents">-</div>
                    <div class="widget-label">From XSIAM</div>
                </div>
                <div class="widget" onclick="switchTab('incidents')">
                    <div class="last-updated" id="criticalLastUpdate">Not synced</div>
                    <h3>Critical Alerts</h3>
                    <div class="widget-value critical" id="criticalAlerts">-</div>
                    <div class="widget-label">High Priority</div>
                </div>
                <div class="widget">
                    <div class="last-updated" id="automationLastUpdate">Just now</div>
                    <h3>Automation Rate</h3>
                    <div class="widget-value" style="color: var(--success);">82%</div>
                    <div class="widget-label">Auto-Resolved</div>
                </div>
            </div>

            <h3 style="margin: 20px 0 12px; color: var(--primary); font-size: 16px;">Customer Tenants</h3>
            <div id="customersList"></div>
        </div>

        <!-- CISO Dashboard -->
        <div id="ciso-dashboard" class="tab-content">
            <h2 style="margin-bottom: 15px; color: var(--primary); font-size: 18px;">CISO Executive Dashboard - <span id="cisoTenantName">ATPL NFR</span></h2>
            
            <div class="dashboard-grid">
                <div class="kpi-card">
                    <div class="kpi-value">2.3h</div>
                    <div class="kpi-label">Mean Time to Respond</div>
                    <div class="kpi-trend trend-up">‚Üì 15% vs last month</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">82%</div>
                    <div class="kpi-label">Auto-Resolved Rate</div>
                    <div class="kpi-trend trend-up">‚Üë 8% improvement</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">94%</div>
                    <div class="kpi-label">SOC Efficiency</div>
                    <div class="kpi-trend trend-up">‚Üë 12% vs manual</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">78%</div>
                    <div class="kpi-label">MITRE Coverage</div>
                    <div class="kpi-trend trend-up">‚Üë 5% this quarter</div>
                </div>
            </div>

            <h3 style="margin: 20px 0 12px; color: var(--primary); font-size: 16px;">Security Posture</h3>
            <div class="dashboard-grid">
                <div class="widget">
                    <h3>Health Score</h3>
                    <div class="widget-value" style="color: var(--success);">87%</div>
                    <div class="widget-label">Overall Security Health</div>
                </div>
                <div class="widget">
                    <h3>Active Threats</h3>
                    <div class="widget-value critical">12</div>
                    <div class="widget-label">Requires Attention</div>
                </div>
                <div class="widget">
                    <h3>Compliance Score</h3>
                    <div class="widget-value" style="color: var(--success);">92%</div>
                    <div class="widget-label">Regulatory Compliance</div>
                </div>
            </div>

            <h3 style="margin: 20px 0 12px; color: var(--primary); font-size: 16px;">Data Sources Status</h3>
            <div class="form-section">
                <div class="data-source-item">
                    <span class="source-name">Palo Alto Firewall</span>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div class="status-dot online"></div>
                        <span style="font-size: 11px;">Online - 1,247 events - 2 min ago</span>
                    </div>
                </div>
                <div class="data-source-item">
                    <span class="source-name">Microsoft Defender</span>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div class="status-dot online"></div>
                        <span style="font-size: 11px;">Online - 892 events - 1 min ago</span>
                    </div>
                </div>
                <div class="data-source-item">
                    <span class="source-name">AWS CloudTrail</span>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div class="status-dot warning"></div>
                        <span style="font-size: 11px;">Delayed - 3,456 events - 15 min ago</span>
                    </div>
                </div>
                <div class="data-source-item">
                    <span class="source-name">Azure AD</span>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div class="status-dot online"></div>
                        <span style="font-size: 11px;">Online - 567 events - 3 min ago</span>
                    </div>
                </div>
                <div class="data-source-item">
                    <span class="source-name">CrowdStrike EDR</span>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div class="status-dot online"></div>
                        <span style="font-size: 11px;">Online - 2,134 events - 1 min ago</span>
                    </div>
                </div>
                <div class="data-source-item">
                    <span class="source-name">Office 365</span>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div class="status-dot online"></div>
                        <span style="font-size: 11px;">Online - 789 events - 5 min ago</span>
                    </div>
                </div>
            </div>

            <h3 style="margin: 20px 0 12px; color: var(--primary); font-size: 16px;">MITRE ATT&CK Coverage</h3>
            <div class="form-section">
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 600;">Overall Coverage</span>
                        <span style="font-weight: 600; color: var(--success);">78%</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); height: 20px; border-radius: 10px; overflow: hidden;">
                        <div style="background: var(--success); height: 100%; width: 78%; border-radius: 10px;"></div>
                    </div>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                    Covered Techniques: 142/182 | Partial Coverage: 28 | Not Covered: 12
                </div>
            </div>

            <h3 style="margin: 20px 0 12px; color: var(--primary); font-size: 16px;">Attack Surface Exposure</h3>
            <div class="dashboard-grid">
                <div class="widget">
                    <h3>Critical Exposures</h3>
                    <div class="widget-value critical">12</div>
                    <div class="widget-label">Immediate Action Required</div>
                </div>
                <div class="widget">
                    <h3>High Risk Assets</h3>
                    <div class="widget-value high">34</div>
                    <div class="widget-label">Needs Remediation</div>
                </div>
                <div class="widget">
                    <h3>Internet-Facing</h3>
                    <div class="widget-value">156</div>
                    <div class="widget-label">Public Assets</div>
                </div>
                <div class="widget">
                    <h3>Patched Systems</h3>
                    <div class="widget-value" style="color: var(--success);">89%</div>
                    <div class="widget-label">Up to Date</div>
                </div>
            </div>
        </div>

        <!-- Analyst Workspace -->
        <div id="analyst-view" class="tab-content">
            <h2 style="margin-bottom: 15px; color: var(--primary); font-size: 18px;">SOC Analyst Workspace - <span id="analystTenantName">ATPL NFR</span></h2>
            
            <div class="two-column">
                <div class="form-section">
                    <h3>üìã My Queue (<span id="queueCount">0</span>)</h3>
                    <div id="analystQueue" style="max-height: 600px; overflow-y: auto;">
                        <p style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            Click "Fetch Live Cases" to load incidents
                        </p>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ü§ñ AI-Powered Analysis</h3>
                    <div id="aiAnalysisPanel">
                        <p style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            Select an incident to view AI analysis with causality chains and artifact analysis
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SOC Manager View -->
        <div id="manager-view" class="tab-content">
            <h2 style="margin-bottom: 15px; color: var(--primary); font-size: 18px;">SOC Manager Dashboard - <span id="managerTenantName">ATPL NFR</span></h2>
            
            <div class="dashboard-grid">
                <div class="widget">
                    <h3>Team Performance</h3>
                    <div class="widget-value" style="color: var(--success);">94%</div>
                    <div class="widget-label">SLA Compliance</div>
                </div>
                <div class="widget">
                    <h3>Pending Cases</h3>
                    <div class="widget-value">23</div>
                    <div class="widget-label">In Queue</div>
                </div>
                <div class="widget">
                    <h3>Avg Resolution Time</h3>
                    <div class="widget-value">2.3h</div>
                    <div class="widget-label">MTTR</div>
                </div>
                <div class="widget">
                    <h3>Analyst Efficiency</h3>
                    <div class="widget-value">87%</div>
                    <div class="widget-label">Productivity Score</div>
                </div>
            </div>

            <h3 style="margin: 20px 0 12px; color: var(--primary); font-size: 16px;">Workload Distribution</h3>
            <div class="form-section">
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 600;">Analyst 1 - John Doe</span>
                        <span>8 cases</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); height: 15px; border-radius: 8px; overflow: hidden;">
                        <div style="background: var(--success); height: 100%; width: 65%;"></div>
                    </div>
                </div>
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 600;">Analyst 2 - Jane Smith</span>
                        <span>12 cases</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); height: 15px; border-radius: 8px; overflow: hidden;">
                        <div style="background: var(--warning); height: 100%; width: 95%;"></div>
                    </div>
                </div>
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 600;">Analyst 3 - Mike Johnson</span>
                        <span>3 cases</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); height: 15px; border-radius: 8px; overflow: hidden;">
                        <div style="background: var(--success); height: 100%; width: 25%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Incidents Tab -->
        <div id="incidents" class="tab-content">
            <h2 style="margin-bottom: 15px; color: var(--primary); font-size: 18px;">
                Live Incidents - <span id="incidentTenantName">ATPL NFR</span>
            </h2>
            
            <div class="two-column">
                <div class="form-section">
                    <h3>üìã Open Incidents (<span id="incidentCount">0</span>)</h3>
                    <div id="incidentsList" style="max-height: 600px; overflow-y: auto;">
                        <p style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            Click "Fetch Live Cases" to load incidents from XSIAM
                        </p>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ü§ñ AI Analysis & Details</h3>
                    <div id="analysisResults">
                        <p style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            Select an incident to view AI-powered analysis with causality chains and artifacts
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Threat Hunting -->
        <div id="threat-hunting" class="tab-content">
            <h2 style="margin-bottom: 15px; color: var(--primary); font-size: 18px;">üéØ Threat Hunting - <span id="huntingTenantName">ATPL NFR</span></h2>
            
            <div class="form-section">
                <h3>üîç Hunt Query Builder</h3>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 12px;">Hunt Type</label>
                    <select id="huntType" style="width: 100%; padding: 9px; background: var(--dark-bg); border: 2px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px;">
                        <option value="ioc">IOC Hunt (IP, Domain, Hash)</option>
                        <option value="behavior">Behavioral Hunt (Anomalies)</option>
                        <option value="lateral">Lateral Movement Detection</option>
                        <option value="persistence">Persistence Mechanisms</option>
                        <option value="exfiltration">Data Exfiltration</option>
                        <option value="privilege">Privilege Escalation</option>
                    </select>
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 12px;">Search Query</label>
                    <textarea id="huntQuery" placeholder="Enter hunt query or IOC..." style="width: 100%; padding: 9px; background: var(--dark-bg); border: 2px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px; min-height: 100px; font-family: 'Courier New', monospace;"></textarea>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="executeHunt()">üéØ Execute Hunt</button>
                    <button class="btn btn-info" onclick="saveHunt()">üíæ Save Hunt</button>
                    <button class="btn btn-success" onclick="scheduleHunt()">‚è∞ Schedule Hunt</button>
                </div>
            </div>

            <div class="form-section">
                <h3>üìä Hunt Results</h3>
                <div id="huntResults">
                    <p style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        Execute a hunt query to see results
                    </p>
                </div>
            </div>

            <h3 style="margin: 20px 0 12px; color: var(--primary); font-size: 16px;">Saved Hunts</h3>
            <div class="dashboard-grid">
                <div class="widget" onclick="loadSavedHunt('lateral-movement')">
                    <h3>Lateral Movement Hunt</h3>
                    <div class="widget-label">Last run: 2 hours ago | 3 findings</div>
                </div>
                <div class="widget" onclick="loadSavedHunt('suspicious-powershell')">
                    <h3>Suspicious PowerShell</h3>
                    <div class="widget-label">Last run: 1 hour ago | 12 findings</div>
                </div>
                <div class="widget" onclick="loadSavedHunt('c2-beaconing')">
                    <h3>C2 Beaconing Detection</h3>
                    <div class="widget-label">Last run: 30 min ago | 0 findings</div>
                </div>
            </div>
        </div>

        <!-- Investigation -->
        <div id="investigation" class="tab-content">
            <h2 style="margin-bottom: 15px; color: var(--primary); font-size: 18px;">üî¨ Investigation Workspace - <span id="investigationTenantName">ATPL NFR</span></h2>
            
            <div class="two-column">
                <div class="form-section">
                    <h3>üîç Investigation Tools</h3>
                    <div class="button-group" style="flex-direction: column; align-items: stretch;">
                        <button class="btn btn-primary" onclick="investigateHost()">üíª Host Investigation</button>
                        <button class="btn btn-primary" onclick="investigateUser()">üë§ User Investigation</button>
                        <button class="btn btn-primary" onclick="investigateIP()">üåê IP Investigation</button>
                        <button class="btn btn-primary" onclick="investigateDomain()">üîó Domain Investigation</button>
                        <button class="btn btn-primary" onclick="investigateHash()">üîê File Hash Investigation</button>
                        <button class="btn btn-primary" onclick="investigateEmail()">üìß Email Investigation</button>
                    </div>
                    
                    <h3 style="margin-top: 20px;">üß© Pivot Points</h3>
                    <div id="pivotPoints">
                        <p style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 11px;">
                            Select an incident to see pivot points
                        </p>
                    </div>
                </div>

                <div class="form-section">
                    <h3>üìä Investigation Results</h3>
                    <div id="investigationResults">
                        <p style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            Use investigation tools to analyze entities
                        </p>
                    </div>
                </div>
            </div>

            <h3 style="margin: 20px 0 12px; color: var(--primary); font-size: 16px;">Recent Investigations</h3>
            <div class="form-section">
                <div class="data-source-item">
                    <span>Host: DESKTOP-ABC123 | Ransomware Investigation</span>
                    <span style="font-size: 11px; color: var(--text-secondary);">2 hours ago</span>
                </div>
                <div class="data-source-item">
                    <span>User: john.doe@company.com | Phishing Investigation</span>
                    <span style="font-size: 11px; color: var(--text-secondary);">4 hours ago</span>
                </div>
                <div class="data-source-item">
                    <span>IP: 192.168.1.100 | C2 Communication Investigation</span>
                    <span style="font-size: 11px; color: var(--text-secondary);">6 hours ago</span>
                </div>
            </div>
        </div>

        <!-- Threat Intel -->
        <div id="threat-intel" class="tab-content">
            <h2 style="margin-bottom: 15px; color: var(--primary); font-size: 18px;">üîç Threat Intelligence Feed</h2>
            
            <div class="form-section">
                <h3>üö® Critical Threats (Last 7 Days)</h3>
                <div style="background: rgba(220,53,69,0.1); padding: 15px; border-radius: 6px; border-left: 3px solid var(--danger); margin-bottom: 10px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">CVE-2025-12345: Critical RCE in Apache Struts</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">Severity: Critical | CVSS: 9.8 | Published: 2 days ago</div>
                </div>
                <div style="background: rgba(220,53,69,0.1); padding: 15px; border-radius: 6px; border-left: 3px solid var(--danger); margin-bottom: 10px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">LockBit 4.0 Ransomware Campaign</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">Severity: High | Active targeting financial sector</div>
                </div>
                <div style="background: rgba(253,126,20,0.1); padding: 15px; border-radius: 6px; border-left: 3px solid var(--high); margin-bottom: 10px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">Microsoft Exchange Zero-Day Exploitation</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">Severity: High | CVSS: 8.1 | Patch available</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="widget">
                    <h3>IOC Feed</h3>
                    <div style="margin-top: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px;">Malicious IPs</span>
                            <span style="font-weight: bold;">1,247</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px;">Malicious Domains</span>
                            <span style="font-weight: bold;">892</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px;">File Hashes</span>
                            <span style="font-weight: bold;">3,456</span>
                        </div>
                    </div>
                </div>
                <div class="widget">
                    <h3>Threat Actors</h3>
                    <div style="margin-top: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px;">APT Groups</span>
                            <span style="font-weight: bold;">45</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px;">Active Campaigns</span>
                            <span style="font-weight: bold;">12</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px;">Ransomware Families</span>
                            <span style="font-weight: bold;">28</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cloud Command -->
        <div id="cloud-command" class="tab-content">
            <h2 style="margin-bottom: 15px; color: var(--primary); font-size: 18px;">‚òÅÔ∏è Cloud Command Center - <span id="cloudTenantName">ATPL NFR</span></h2>
            
            <div class="dashboard-grid">
                <div class="widget">
                    <h3>AWS</h3>
                    <div class="widget-value">342</div>
                    <div class="widget-label">Total Assets</div>
                    <div style="margin-top: 10px; font-size: 11px; color: var(--danger);">
                        Critical Issues: 12
                    </div>
                </div>
                <div class="widget">
                    <h3>Azure</h3>
                    <div class="widget-value">218</div>
                    <div class="widget-label">Total Assets</div>
                    <div style="margin-top: 10px; font-size: 11px; color: var(--high);">
                        High Issues: 8
                    </div>
                </div>
                <div class="widget">
                    <h3>GCP</h3>
                    <div class="widget-value">156</div>
                    <div class="widget-label">Total Assets</div>
                    <div style="margin-top: 10px; font-size: 11px; color: var(--medium);">
                        Medium Issues: 5
                    </div>
                </div>
                <div class="widget">
                    <h3>Compliance Score</h3>
                    <div class="widget-value" style="color: var(--success);">87%</div>
                    <div class="widget-label">Multi-Cloud</div>
                </div>
            </div>

            <h3 style="margin: 20px 0 12px; color: var(--primary); font-size: 16px;">AWS Resources</h3>
            <div class="form-section">
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 600;">EC2 Instances</span>
                        <span>45 instances | 3 issues</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); height: 15px; border-radius: 8px; overflow: hidden;">
                        <div style="background: var(--success); height: 100%; width: 93%;"></div>
                    </div>
                </div>
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 600;">S3 Buckets</span>
                        <span>28 buckets | 5 issues</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); height: 15px; border-radius: 8px; overflow: hidden;">
                        <div style="background: var(--warning); height: 100%; width: 82%;"></div>
                    </div>
                </div>
            </div>

            <h3 style="margin: 20px 0 12px; color: var(--primary); font-size: 16px;">Azure Resources</h3>
            <div class="form-section">
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 600;">Virtual Machines</span>
                        <span>32 VMs | 2 issues</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); height: 15px; border-radius: 8px; overflow: hidden;">
                        <div style="background: var(--success); height: 100%; width: 94%;"></div>
                    </div>
                </div>
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 600;">Storage Accounts</span>
                        <span>18 accounts | 3 issues</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); height: 15px; border-radius: 8px; overflow: hidden;">
                        <div style="background: var(--success); height: 100%; width: 83%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Integrations Tab -->
        <div id="integrations" class="tab-content">
            <h2 style="margin-bottom: 15px; color: var(--primary); font-size: 18px;">
                Integration Health Monitor - <span id="integrationTenantName">ATPL NFR</span>
            </h2>

            <div class="form-section">
                <h3>üîå XSIAM Connection Status</h3>
                <div class="data-source-item">
                    <span style="font-weight: 600;">API Endpoint</span>
                    <span style="font-size: 11px; font-family: monospace;">api-atpl-nfr.xdr.in.paloaltonetworks.com</span>
                </div>
                <div class="data-source-item">
                    <span style="font-weight: 600;">Connection Status</span>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div class="status-dot offline" id="connectionStatus"></div>
                        <span id="connectionStatusText">Not connected</span>
                    </div>
                </div>
                <div class="data-source-item">
                    <span style="font-weight: 600;">Last Successful Fetch</span>
                    <span id="lastFetchTime">Never</span>
                </div>
                <div class="data-source-item">
                    <span style="font-weight: 600;">Total Incidents Retrieved</span>
                    <span id="totalRetrieved">0</span>
                </div>
            </div>

            <div class="form-section">
                <h3>üìù Last Error</h3>
                <div style="background: rgba(220,53,69,0.1); padding: 15px; border-radius: 6px; font-family: monospace; font-size: 11px; min-height: 60px;">
                    <span id="lastError">None - Click "Fetch Live Cases" to test connection</span>
                </div>
            </div>

            <h3 style="margin: 20px 0 12px; color: var(--primary); font-size: 16px;">Data Source Health</h3>
            <div class="dashboard-grid">
                <div class="widget">
                    <h3>Palo Alto Firewall</h3>
                    <div style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
                        <div class="status-dot online"></div>
                        <span style="font-size: 14px; font-weight: 600; color: var(--success);">Healthy</span>
                    </div>
                    <div class="widget-label">Events: 1,247 | Last: 2 min ago</div>
                </div>
                <div class="widget">
                    <h3>Microsoft Defender</h3>
                    <div style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
                        <div class="status-dot online"></div>
                        <span style="font-size: 14px; font-weight: 600; color: var(--success);">Healthy</span>
                    </div>
                    <div class="widget-label">Events: 892 | Last: 1 min ago</div>
                </div>
                <div class="widget">
                    <h3>AWS CloudTrail</h3>
                    <div style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
                        <div class="status-dot warning"></div>
                        <span style="font-size: 14px; font-weight: 600; color: var(--warning);">Delayed</span>
                    </div>
                    <div class="widget-label">Events: 3,456 | Last: 15 min ago</div>
                </div>
                <div class="widget">
                    <h3>Azure AD</h3>
                    <div style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
                        <div class="status-dot online"></div>
                        <span style="font-size: 14px; font-weight: 600; color: var(--success);">Healthy</span>
                    </div>
                    <div class="widget-label">Events: 567 | Last: 3 min ago</div>
                </div>
                <div class="widget">
                    <h3>CrowdStrike EDR</h3>
                    <div style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
                        <div class="status-dot online"></div>
                        <span style="font-size: 14px; font-weight: 600; color: var(--success);">Healthy</span>
                    </div>
                    <div class="widget-label">Events: 2,134 | Last: 1 min ago</div>
                </div>
                <div class="widget">
                    <h3>Office 365</h3>
                    <div style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
                        <div class="status-dot online"></div>
                        <span style="font-size: 14px; font-weight: 600; color: var(--success);">Healthy</span>
                    </div>
                    <div class="widget-label">Events: 789 | Last: 5 min ago</div>
                </div>
            </div>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="tab-content">
            <h2 style="margin-bottom: 15px; color: var(--primary); font-size: 18px;">Customer Management</h2>
            
            <div class="form-section">
                <h3>üíº Active Customers</h3>
                <div id="savedCustomersList"></div>
            </div>
        </div>
    </div>

    <!-- Onboard Modal -->
    <div id="onboardModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>‚ûï Onboard New Customer</h2>
                <button class="close-btn" onclick="closeOnboardModal()">‚úï Close</button>
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 12px;">Customer Name *</label>
                <input type="text" id="onboardName" placeholder="Company Name" style="width: 100%; padding: 9px; background: var(--dark-bg); border: 2px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px;">
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 12px;">XSIAM API URL *</label>
                <input type="url" id="onboardXsiamUrl" placeholder="https://api-xxx.xdr.paloaltonetworks.com" style="width: 100%; padding: 9px; background: var(--dark-bg); border: 2px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px;">
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 12px;">API Key ID *</label>
                <input type="text" id="onboardApiKeyId" style="width: 100%; padding: 9px; background: var(--dark-bg); border: 2px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px;">
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 12px;">API Key *</label>
                <input type="password" id="onboardApiKey" style="width: 100%; padding: 9px; background: var(--dark-bg); border: 2px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px;">
            </div>
            
            <div class="button-group">
                <button class="btn btn-success" onclick="onboardCustomer()">‚úì Onboard Customer</button>
                <button class="btn btn-danger" onclick="closeOnboardModal()">‚úï Cancel</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üëÅÔ∏è Executive Incident Report Preview</h2>
                <button class="close-btn" onclick="closePreviewModal()">‚úï Close</button>
            </div>
            
            <div id="previewContent" class="preview-section"></div>
            
            <div class="button-group" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="sendToCustomer()">üìß Send to Customer</button>
                <button class="btn btn-info" onclick="exportReport()">üíæ Export HTML</button>
                <button class="btn btn-warning" onclick="copyReport()">üìã Copy</button>
                <button class="btn btn-danger" onclick="closePreviewModal()">‚úï Close</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // ==================== GLOBAL STATE ====================
        let customers = {};
        let currentTenant = 'atpl-nfr';
        let currentIncident = null;
        let autoSyncEnabled = true;
        let syncInterval = 30;
        let syncTimer = null;
        let incidents = [];

        // Default ATPL NFR customer
        const defaultCustomer = {
            id: 'atpl-nfr',
            name: 'ATPL NFR Environment',
            apiUrl: 'https://api-atpl-nfr.xdr.in.paloaltonetworks.com',
            apiKeyId: '10',
            apiKey: 'gyljBCKp2NvQRlSHwOpeAl88wL3FMQXVuyUExKyJRGLW3jg3kARRW1281WcYJpDUccjK9PKtsHvCPQozcpEOXZxkib33qrF8IReyUnnyY2gLzOO1vezbez5ULh344VyA',
            status: 'active',
            onboardedDate: new Date().toISOString(),
            contactEmail: 'security@atpl.com'
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            console.log('üöÄ Initializing Enterprise MSSP SOC Platform...');
            
            const stored = localStorage.getItem('mssp_customers');
            if (stored) {
                try {
                    customers = JSON.parse(stored);
                    console.log('‚úÖ Loaded customers:', Object.keys(customers));
                } catch (e) {
                    console.error('‚ùå Error parsing customers:', e);
                    customers = {};
                }
            }

            if (!customers['atpl-nfr']) {
                console.log('‚ûï Adding default ATPL NFR customer');
                customers['atpl-nfr'] = defaultCustomer;
                localStorage.setItem('mssp_customers', JSON.stringify(customers));
            }

            loadCustomers();
            displayCustomersList();
            displaySavedCustomers();
            updateAllTenantNames();
            startAutoSync();
            fetchLiveCases();
            
            console.log('‚úÖ Platform initialized successfully');
        }

        // ==================== AUTO-SYNC ====================
        function toggleAutoSync() {
            autoSyncEnabled = document.getElementById('autoSyncToggle').checked;
            const indicator = document.getElementById('syncIndicator');
            const statusText = document.getElementById('syncStatusText');
            
            if (autoSyncEnabled) {
                indicator.classList.remove('inactive');
                statusText.textContent = 'Active';
                statusText.style.color = 'var(--success)';
                startAutoSync();
                showAlert('‚úÖ Auto-sync enabled', 'success');
            } else {
                indicator.classList.add('inactive');
                statusText.textContent = 'Inactive';
                statusText.style.color = 'var(--danger)';
                stopAutoSync();
                showAlert('‚è∏Ô∏è Auto-sync disabled', 'info');
            }
        }

        function updateSyncInterval() {
            syncInterval = parseInt(document.getElementById('syncInterval').value);
            if (autoSyncEnabled) {
                stopAutoSync();
                startAutoSync();
                showAlert(`‚è±Ô∏è Sync interval: ${syncInterval}s`, 'info');
            }
        }

        function startAutoSync() {
            if (syncTimer) clearInterval(syncTimer);
            if (autoSyncEnabled) {
                console.log(`üîÑ Auto-sync started: ${syncInterval}s interval`);
                syncTimer = setInterval(fetchLiveCases, syncInterval * 1000);
            }
        }

        function stopAutoSync() {
            if (syncTimer) {
                console.log('‚èπÔ∏è Auto-sync stopped');
                clearInterval(syncTimer);
                syncTimer = null;
            }
        }

        // ==================== XSIAM API ====================
        async function fetchLiveCases() {
            const customer = customers[currentTenant];
            if (!customer) {
                showAlert('‚ùå No customer selected', 'danger');
                return;
            }

            const now = new Date();
            document.getElementById('lastSyncTime').textContent = now.toLocaleTimeString();
            
            console.log('üîÑ Fetching from XSIAM:', customer.apiUrl);
            
            try {
                showAlert('üîÑ Fetching live cases...', 'info');
                
                const nonce = Date.now().toString();
                const authKey = customer.apiKey + nonce;
                const encoder = new TextEncoder();
                const data = encoder.encode(authKey);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                const apiUrl = `${customer.apiUrl}/public_api/v1/incidents/get_incidents/`;
                
                const requestBody = {
                    request_data: {
                        filters: [],
                        search_from: 0,
                        search_to: 100,
                        sort: {
                            field: "creation_time",
                            keyword: "desc"
                        }
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-xdr-auth-id': customer.apiKeyId,
                        'x-xdr-nonce': nonce,
                        'x-xdr-timestamp': Date.now().toString(),
                        'Authorization': hashHex
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('üì• Response:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                
                if (data.reply && data.reply.incidents) {
                    incidents = data.reply.incidents;
                    console.log(`‚úÖ Fetched ${incidents.length} incidents`);
                    
                    updateDashboard();
                    displayIncidents();
                    updateConnectionStatus(true);
                    showAlert(`‚úÖ Fetched ${incidents.length} incidents`, 'success');
                    
                    document.getElementById('lastFetchTime').textContent = now.toLocaleString();
                    document.getElementById('totalRetrieved').textContent = incidents.length;
                    document.getElementById('lastError').textContent = 'None - Connection successful';
                } else {
                    throw new Error('Invalid response format');
                }

            } catch (error) {
                console.error('‚ùå Error:', error);
                updateConnectionStatus(false);
                document.getElementById('lastError').textContent = error.message;
                
                let errorMsg = error.message;
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'Network error: CORS restriction. Deploy backend proxy for production.';
                }
                
                showAlert(`‚ùå ${errorMsg}`, 'danger');
            }

            updateLastUpdatedTimes();
        }

        function updateConnectionStatus(isOnline) {
            const statusDot = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionStatusText');
            
            if (isOnline) {
                statusDot.classList.add('online');
                statusDot.classList.remove('offline');
                statusText.textContent = 'Connected';
                statusText.style.color = 'var(--success)';
            } else {
                statusDot.classList.add('offline');
                statusDot.classList.remove('online');
                statusText.textContent = 'Connection Failed';
                statusText.style.color = 'var(--danger)';
            }
        }

        // ==================== DASHBOARD ====================
        function updateDashboard() {
            const criticalCount = incidents.filter(i => 
                i.severity === 'high' || i.severity === 'critical'
            ).length;
            
            document.getElementById('totalIncidents').textContent = incidents.length;
            document.getElementById('criticalAlerts').textContent = criticalCount;
        }

        function displayIncidents() {
            const container = document.getElementById('incidentsList');
            const queueContainer = document.getElementById('analystQueue');
            
            document.getElementById('incidentCount').textContent = incidents.length;
            document.getElementById('queueCount').textContent = incidents.length;
            
            if (incidents.length === 0) {
                const msg = '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">No incidents found</p>';
                container.innerHTML = msg;
                if (queueContainer) queueContainer.innerHTML = msg;
                return;
            }
            
            const html = incidents.map((inc, index) => {
                const creationTime = new Date(inc.creation_time).toLocaleString();
                
                return `
                    <div class="incident-card" onclick='selectIncident(${index})' id="incident-${index}">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <strong>${inc.incident_id || 'INC-' + (index + 1)}</strong>
                            <span class="status-badge" style="background: rgba(220,53,69,0.2); color: var(--danger);">${inc.severity || 'Unknown'}</span>
                        </div>
                        <div style="font-size: 12px; margin-bottom: 5px;">${inc.description || inc.alert_sources?.[0] || 'No description'}</div>
                        <div style="font-size: 10px; color: var(--text-secondary);">
                            Created: ${creationTime} | Status: ${inc.status || 'Unknown'}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            if (queueContainer) queueContainer.innerHTML = html;
        }

        function selectIncident(index) {
            currentIncident = incidents[index];
            
            document.querySelectorAll('.incident-card').forEach(card => {
                card.classList.remove('selected');
            });
            const selectedCard = document.getElementById(`incident-${index}`);
            if (selectedCard) selectedCard.classList.add('selected');
            
            showIncidentDetails(currentIncident);
            updatePivotPoints(currentIncident);
        }

        function showIncidentDetails(incident) {
            const panel = document.getElementById('analysisResults') || document.getElementById('aiAnalysisPanel');
            const creationTime = new Date(incident.creation_time).toLocaleString();
            
            // Generate AI analysis with causality chain and artifacts
            const causalityChain = generateCausalityChain(incident);
            const artifacts = generateArtifacts(incident);
            
            panel.innerHTML = `
                <div style="background: rgba(23,162,184,0.1); padding: 20px; border-radius: 8px; border: 2px solid var(--info);">
                    <h4 style="color: var(--info); margin-bottom: 15px;">ü§ñ AI-Powered Analysis: ${incident.incident_id || 'N/A'}</h4>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>Severity:</strong> <span class="${incident.severity === 'high' ? 'critical' : incident.severity}">${incident.severity || 'Unknown'}</span><br>
                        <strong>Status:</strong> ${incident.status || 'Unknown'}<br>
                        <strong>Created:</strong> ${creationTime}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>üìù Description:</strong>
                        <p style="margin-top: 8px; font-size: 12px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;">
                            ${incident.description || 'No description available'}
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>üîó Causality Chain:</strong>
                        ${causalityChain}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>üì¶ Analyzed Artifacts:</strong>
                        ${artifacts}
                    </div>
                    
                    ${incident.alert_sources && incident.alert_sources.length > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <strong>üîç Alert Sources:</strong>
                        <p style="margin-top: 8px; font-size: 12px;">
                            ${incident.alert_sources.join(', ')}
                        </p>
                    </div>
                    ` : ''}
                    
                    ${incident.hosts && incident.hosts.length > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <strong>üíª Affected Hosts:</strong>
                        <p style="margin-top: 8px; font-size: 12px;">
                            ${incident.hosts.join(', ')}
                        </p>
                    </div>
                    ` : ''}
                    
                    ${incident.users && incident.users.length > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <strong>üë§ Affected Users:</strong>
                        <p style="margin-top: 8px; font-size: 12px;">
                            ${incident.users.join(', ')}
                        </p>
                    </div>
                    ` : ''}
                    
                    <div class="button-group" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="showEnhancedPreview()">üëÅÔ∏è Executive Report</button>
                        <button class="btn btn-primary" onclick="updateIncidentStatus()">‚úì Update Status</button>
                        <button class="btn btn-info" onclick="assignIncident()">üë§ Assign</button>
                        <button class="btn btn-warning" onclick="escalateIncident()">‚ö†Ô∏è Escalate</button>
                    </div>
                </div>
            `;
        }

        function generateCausalityChain(incident) {
            // AI-generated causality chain based on incident type
            const chains = {
                'phishing': ['Phishing Email Received', 'Malicious Link Clicked', 'Credential Harvesting', 'Unauthorized Access', 'Data Exfiltration'],
                'ransomware': ['Initial Access', 'Malware Execution', 'Privilege Escalation', 'Lateral Movement', 'Data Encryption', 'Ransom Demand'],
                'malware': ['Malicious File Downloaded', 'Execution', 'Persistence Established', 'C2 Communication', 'Data Collection'],
                'default': ['Initial Detection', 'Analysis Phase', 'Containment', 'Investigation', 'Remediation']
            };
            
            let chain = chains.default;
            const desc = (incident.description || '').toLowerCase();
            
            if (desc.includes('phish') || desc.includes('email')) chain = chains.phishing;
            else if (desc.includes('ransom') || desc.includes('encrypt')) chain = chains.ransomware;
            else if (desc.includes('malware') || desc.includes('virus')) chain = chains.malware;
            
            return `
                <div class="causality-chain">
                    ${chain.map((step, i) => `
                        <div class="causality-step">${i + 1}. ${step}</div>
                        ${i < chain.length - 1 ? '<div class="causality-arrow">‚Üí</div>' : ''}
                    `).join('')}
                </div>
            `;
        }

        function generateArtifacts(incident) {
            // Generate artifact list based on incident data
            const artifacts = [];
            
            if (incident.hosts && incident.hosts.length > 0) {
                artifacts.push(`Hosts: ${incident.hosts.join(', ')}`);
            }
            if (incident.users && incident.users.length > 0) {
                artifacts.push(`Users: ${incident.users.join(', ')}`);
            }
            if (incident.alert_sources && incident.alert_sources.length > 0) {
                artifacts.push(`Detection Sources: ${incident.alert_sources.join(', ')}`);
            }
            
            // Add sample artifacts for demonstration
            artifacts.push('File Hash: SHA256:a3f5b2c1d4e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3w4x5y6z7');
            artifacts.push('IP Address: 192.168.1.100 (Internal), 203.0.113.45 (External C2)');
            artifacts.push('Domain: malicious-domain.com');
            artifacts.push('Process: powershell.exe -EncodedCommand [Base64]');
            
            return `
                <div class="artifact-list">
                    ${artifacts.map(a => `‚Ä¢ ${a}`).join('<br>')}
                </div>
            `;
        }

        function updatePivotPoints(incident) {
            const panel = document.getElementById('pivotPoints');
            if (!panel) return;
            
            const pivots = [];
            if (incident.hosts && incident.hosts.length > 0) {
                incident.hosts.forEach(host => {
                    pivots.push(`<button class="btn btn-info" style="width: 100%; margin-bottom: 5px;" onclick="investigateHost('${host}')">üñ•Ô∏è Investigate Host: ${host}</button>`);
                });
            }
            if (incident.users && incident.users.length > 0) {
                incident.users.forEach(user => {
                    pivots.push(`<button class="btn btn-info" style="width: 100%; margin-bottom: 5px;" onclick="investigateUser('${user}')">üë§ Investigate User: ${user}</button>`);
                });
            }
            
            panel.innerHTML = pivots.length > 0 ? pivots.join('') : '<p style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 11px;">No pivot points available</p>';
        }

        // ==================== EXECUTIVE REPORT ====================
        function showEnhancedPreview() {
            if (!currentIncident) {
                showAlert('‚ùå No incident selected', 'danger');
                return;
            }
            
            const customer = customers[currentTenant];
            const creationTime = new Date(currentIncident.creation_time).toLocaleString();
            const causalityChain = generateCausalityChain(currentIncident);
            const artifacts = generateArtifacts(currentIncident);
            
            const previewHTML = `
                <div class="preview-header">
                    <h1>üõ°Ô∏è Security Incident Response Report</h1>
                    <div class="subtitle" style="font-size: 14px; color: #666; margin-top: 10px;">Confidential Executive Summary</div>
                </div>

                <div class="executive-summary">
                    <h2 style="color: var(--primary); font-size: 20px; margin-bottom: 15px;">üìä Executive Summary</h2>
                    <div style="margin: 15px 0;">
                        <span class="severity-indicator severity-critical">${currentIncident.severity || 'UNKNOWN'} SEVERITY INCIDENT</span>
                    </div>
                    <p style="font-size: 15px; line-height: 1.8; margin-top: 15px; color: #333;">
                        A security incident has been detected and is being actively investigated by our SOC team. 
                        This report provides comprehensive details including causality chain analysis, artifact examination, 
                        and actionable recommendations for executive decision-making and remediation planning.
                    </p>
                </div>

                <div class="info-grid">
                    <div class="info-card">
                        <div class="label">Incident ID</div>
                        <div class="value">${currentIncident.incident_id || 'N/A'}</div>
                    </div>
                    <div class="info-card">
                        <div class="label">Customer</div>
                        <div class="value">${customer?.name || 'N/A'}</div>
                    </div>
                    <div class="info-card">
                        <div class="label">Detection Time</div>
                        <div class="value">${creationTime}</div>
                    </div>
                    <div class="info-card">
                        <div class="label">Status</div>
                        <div class="value" style="color: var(--warning);">${currentIncident.status || 'Under Investigation'}</div>
                    </div>
                </div>

                <div class="section-block">
                    <h3>üîç Incident Overview</h3>
                    <p><strong>Description:</strong> ${currentIncident.description || 'Detailed analysis in progress'}</p>
                    ${currentIncident.alert_sources ? `<p style="margin-top: 10px;"><strong>Detection Sources:</strong> ${currentIncident.alert_sources.join(', ')}</p>` : ''}
                    ${currentIncident.hosts ? `<p style="margin-top: 10px;"><strong>Affected Systems:</strong> ${currentIncident.hosts.join(', ')}</p>` : ''}
                    ${currentIncident.users ? `<p style="margin-top: 10px;"><strong>Affected Users:</strong> ${currentIncident.users.join(', ')}</p>` : ''}
                </div>

                <div class="section-block">
                    <h3>üîó Attack Causality Chain</h3>
                    <p style="margin-bottom: 15px;">AI-powered analysis has reconstructed the following attack progression:</p>
                    ${causalityChain}
                </div>

                <div class="section-block">
                    <h3>üì¶ Analyzed Artifacts</h3>
                    <p style="margin-bottom: 10px;">The following artifacts have been identified and analyzed:</p>
                    ${artifacts}
                </div>

                <div class="section-block" style="background: rgba(40,167,69,0.05); border-left-color: var(--success);">
                    <h3 style="color: var(--success);">‚úÖ Recommended Actions</h3>
                    <ul class="action-steps">
                        <li><strong>Immediate (0-15 min):</strong> Isolate affected systems from network to prevent lateral movement</li>
                        <li><strong>Short-term (15-60 min):</strong> Collect forensic evidence and preserve logs for investigation</li>
                        <li><strong>Medium-term (1-4 hours):</strong> Conduct thorough investigation using threat hunting techniques</li>
                        <li><strong>Long-term (4-24 hours):</strong> Implement remediation measures and strengthen security controls</li>
                        <li><strong>Post-incident:</strong> Update incident response procedures and conduct lessons learned session</li>
                    </ul>
                </div>

                <div class="section-block" style="background: rgba(220,53,69,0.05); border-left-color: var(--danger);">
                    <h3 style="color: var(--danger);">üíº Business Impact Assessment</h3>
                    <p><strong>Operational Impact:</strong> Potential disruption to business operations requiring immediate attention</p>
                    <p style="margin-top: 10px;"><strong>Financial Impact:</strong> Estimated cost of incident response and potential data loss</p>
                    <p style="margin-top: 10px;"><strong>Compliance Impact:</strong> May require regulatory notification depending on data involved</p>
                </div>

                <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid #dee2e6; color: #666; font-size: 11px;">
                    <p><strong>Report Generated:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>Platform:</strong> Enterprise MSSP SOC Platform | XSIAM Integration</p>
                    <p><strong>Classification:</strong> CONFIDENTIAL - For Authorized Personnel Only</p>
                    <p style="margin-top: 10px;"><strong>Distribution:</strong> CISO, Security Team, Executive Leadership</p>
                </div>
            `;
            
            document.getElementById('previewContent').innerHTML = previewHTML;
            document.getElementById('previewModal').classList.add('show');
        }

        function closePreviewModal() {
            document.getElementById('previewModal').classList.remove('show');
        }

        function sendToCustomer() {
            const customer = customers[currentTenant];
            showAlert(`üìß Executive report sent to ${customer?.contactEmail || 'customer'}`, 'success');
            closePreviewModal();
        }

        function exportReport() {
            const content = document.getElementById('previewContent').innerHTML;
            const fullHTML = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Security Incident Report</title><style>body{font-family:Arial,sans-serif;max-width:1200px;margin:40px auto;padding:30px;background:#f5f5f5}.preview-header{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid #0066cc}.executive-summary{background:rgba(0,102,204,0.1);padding:25px;border-radius:10px;margin-bottom:25px;border-left:5px solid #0066cc}.severity-indicator{display:inline-block;padding:8px 20px;border-radius:20px;font-weight:bold}.severity-critical{background:#dc3545;color:white}.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}.info-card{background:white;padding:15px;border-radius:8px;border:2px solid #e0e0e0}.section-block{background:white;padding:25px;border-radius:10px;margin-bottom:20px;border-left:5px solid #17a2b8}.action-steps{counter-reset:step-counter;list-style:none}.action-steps li{counter-increment:step-counter;margin-bottom:15px;padding-left:40px;position:relative}.action-steps li:before{content:counter(step-counter);position:absolute;left:0;top:0;background:#0066cc;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold}.causality-chain{display:flex;align-items:center;gap:10px;flex-wrap:wrap}.causality-step{background:#17a2b8;color:white;padding:10px 15px;border-radius:8px;font-size:12px;font-weight:600}.causality-arrow{font-size:20px;color:#0066cc;font-weight:bold}.artifact-list{background:rgba(0,0,0,0.05);padding:15px;border-radius:8px;font-family:monospace;font-size:12px}</style></head><body>${content}</body></html>`;
            
            const blob = new Blob([fullHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `incident-report-${currentIncident?.incident_id || Date.now()}.html`;
            a.click();
            showAlert('üíæ Executive report exported', 'success');
        }

        function copyReport() {
            const content = document.getElementById('previewContent').innerText;
            navigator.clipboard.writeText(content).then(() => {
                showAlert('üìã Report copied to clipboard', 'success');
            });
        }

        // ==================== THREAT HUNTING ====================
        function executeHunt() {
            const huntType = document.getElementById('huntType').value;
            const query = document.getElementById('huntQuery').value;
            
            if (!query) {
                showAlert('‚ö†Ô∏è Please enter a hunt query', 'warning');
                return;
            }
            
            showAlert('üéØ Executing hunt query...', 'info');
            
            // Simulate hunt results
            setTimeout(() => {
                const results = `
                    <div style="background: rgba(40,167,69,0.1); padding: 15px; border-radius: 6px; border-left: 3px solid var(--success); margin-bottom: 10px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">‚úÖ Hunt Completed Successfully</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Hunt Type: ${huntType} | Query: ${query}</div>
                    </div>
                    <div style="margin-top: 15px;">
                        <strong>Findings: 3 matches</strong>
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 12px;">
                            ‚Ä¢ Host: DESKTOP-ABC123 | Time: ${new Date().toLocaleString()}<br>
                            ‚Ä¢ Host: LAPTOP-XYZ789 | Time: ${new Date(Date.now() - 3600000).toLocaleString()}<br>
                            ‚Ä¢ Host: SERVER-001 | Time: ${new Date(Date.now() - 7200000).toLocaleString()}
                        </div>
                    </div>
                `;
                document.getElementById('huntResults').innerHTML = results;
                showAlert('‚úÖ Hunt completed: 3 findings', 'success');
            }, 2000);
        }

        function saveHunt() {
            showAlert('üíæ Hunt query saved', 'success');
        }

        function scheduleHunt() {
            showAlert('‚è∞ Hunt scheduled for recurring execution', 'success');
        }

        function loadSavedHunt(huntId) {
            showAlert(`üìÇ Loaded saved hunt: ${huntId}`, 'info');
        }

        // ==================== INVESTIGATION ====================
        function investigateHost(host) {
            const results = `
                <div style="background: rgba(23,162,184,0.1); padding: 20px; border-radius: 8px; border: 2px solid var(--info);">
                    <h4 style="color: var(--info); margin-bottom: 15px;">üíª Host Investigation: ${host || 'Unknown'}</h4>
                    <div style="margin-bottom: 10px;"><strong>OS:</strong> Windows 10 Enterprise</div>
                    <div style="margin-bottom: 10px;"><strong>Last Seen:</strong> ${new Date().toLocaleString()}</div>
                    <div style="margin-bottom: 10px;"><strong>IP Address:</strong> 192.168.1.100</div>
                    <div style="margin-bottom: 10px;"><strong>Running Processes:</strong> 156</div>
                    <div style="margin-bottom: 10px;"><strong>Network Connections:</strong> 23 active</div>
                    <div style="margin-bottom: 10px;"><strong>Suspicious Activity:</strong> <span style="color: var(--danger);">Yes - Unusual PowerShell execution detected</span></div>
                </div>
            `;
            document.getElementById('investigationResults').innerHTML = results;
            showAlert(`üîç Investigating host: ${host}`, 'info');
        }

        function investigateUser(user) {
            const results = `
                <div style="background: rgba(23,162,184,0.1); padding: 20px; border-radius: 8px; border: 2px solid var(--info);">
                    <h4 style="color: var(--info); margin-bottom: 15px;">üë§ User Investigation: ${user || 'Unknown'}</h4>
                    <div style="margin-bottom: 10px;"><strong>Email:</strong> ${user}</div>
                    <div style="margin-bottom: 10px;"><strong>Last Login:</strong> ${new Date().toLocaleString()}</div>
                    <div style="margin-bottom: 10px;"><strong>Failed Logins:</strong> 3 (last 24h)</div>
                    <div style="margin-bottom: 10px;"><strong>Accessed Resources:</strong> 45 files, 12 applications</div>
                    <div style="margin-bottom: 10px;"><strong>Risk Score:</strong> <span style="color: var(--warning);">Medium (65/100)</span></div>
                </div>
            `;
            document.getElementById('investigationResults').innerHTML = results;
            showAlert(`üîç Investigating user: ${user}`, 'info');
        }

        function investigateIP() {
            showAlert('üåê IP investigation launched', 'info');
        }

        function investigateDomain() {
            showAlert('üîó Domain investigation launched', 'info');
        }

        function investigateHash() {
            showAlert('üîê File hash investigation launched', 'info');
        }

        function investigateEmail() {
            showAlert('üìß Email investigation launched', 'info');
        }

        // ==================== INCIDENT ACTIONS ====================
        function updateIncidentStatus() {
            showAlert('‚úÖ Incident status updated', 'success');
        }

        function assignIncident() {
            showAlert('üë§ Incident assigned to analyst', 'success');
        }

        function escalateIncident() {
            showAlert('‚ö†Ô∏è Incident escalated to senior analyst', 'warning');
        }

        // ==================== CUSTOMER MANAGEMENT ====================
        function loadCustomers() {
            const selector = document.getElementById('tenantSelector');
            selector.innerHTML = '';
            
            Object.keys(customers).forEach(id => {
                const customer = customers[id];
                if (customer.status === 'active') {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = 'üè¢ ' + customer.name + (id === 'atpl-nfr' ? ' (Default)' : '');
                    selector.appendChild(option);
                }
            });
            
            selector.value = currentTenant;
        }

        function displayCustomersList() {
            const container = document.getElementById('customersList');
            const customer = customers[currentTenant];
            
            if (!customer) return;
            
            const criticalCount = incidents.filter(i => i.severity === 'high' || i.severity === 'critical').length;
            const highCount = incidents.filter(i => i.severity === 'high').length;
            const mediumCount = incidents.filter(i => i.severity === 'medium').length;
            const lowCount = incidents.filter(i => i.severity === 'low').length;
            
            container.innerHTML = `
                <div class="customer-card">
                    <div class="customer-header">
                        <div class="customer-name">üè¢ ${customer.name}</div>
                        <span class="status-badge status-active">Active</span>
                    </div>
                    <div class="severity-breakdown">
                        <div class="severity-item">
                            <div class="count critical">${criticalCount}</div>
                            <div class="label">Critical</div>
                        </div>
                        <div class="severity-item">
                            <div class="count high">${highCount}</div>
                            <div class="label">High</div>
                        </div>
                        <div class="severity-item">
                            <div class="count medium">${mediumCount}</div>
                            <div class="label">Medium</div>
                        </div>
                        <div class="severity-item">
                            <div class="count low">${lowCount}</div>
                            <div class="label">Low</div>
                        </div>
                    </div>
                    <div style="margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                        <strong>API:</strong> ${customer.apiUrl}<br>
                        <strong>Onboarded:</strong> ${new Date(customer.onboardedDate).toLocaleDateString()}<br>
                        <strong>Total Incidents:</strong> ${incidents.length}
                    </div>
                </div>
            `;
        }

        function displaySavedCustomers() {
            const container = document.getElementById('savedCustomersList');
            const activeCustomers = Object.values(customers).filter(c => c.status === 'active');
            
            if (activeCustomers.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">No customers onboarded</p>';
                return;
            }
            
            container.innerHTML = activeCustomers.map(c => `
                <div class="customer-card">
                    <div class="customer-header">
                        <div class="customer-name">üè¢ ${c.name}</div>
                        <span class="status-badge status-active">Active</span>
                    </div>
                    <div style="margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                        <strong>API Endpoint:</strong> ${c.apiUrl}<br>
                        <strong>API Key ID:</strong> ${c.apiKeyId}<br>
                        <strong>Onboarded:</strong> ${new Date(c.onboardedDate).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        }

        function showOnboardModal() {
            document.getElementById('onboardModal').classList.add('show');
        }

        function closeOnboardModal() {
            document.getElementById('onboardModal').classList.remove('show');
        }

        function onboardCustomer() {
            const name = document.getElementById('onboardName').value;
            const apiUrl = document.getElementById('onboardXsiamUrl').value;
            const apiKeyId = document.getElementById('onboardApiKeyId').value;
            const apiKey = document.getElementById('onboardApiKey').value;
            
            if (!name || !apiUrl || !apiKeyId || !apiKey) {
                showAlert('‚ùå Please fill all fields', 'danger');
                return;
            }
            
            const id = name.toLowerCase().replace(/\s+/g, '-');
            customers[id] = {
                id, name, apiUrl, apiKeyId, apiKey,
                status: 'active',
                onboardedDate: new Date().toISOString(),
                contactEmail: ''
            };
            
            localStorage.setItem('mssp_customers', JSON.stringify(customers));
            loadCustomers();
            displayCustomersList();
            displaySavedCustomers();
            closeOnboardModal();
            showAlert(`‚úÖ Customer "${name}" onboarded!`, 'success');
            
            document.getElementById('onboardName').value = '';
            document.getElementById('onboardXsiamUrl').value = '';
            document.getElementById('onboardApiKeyId').value = '';
            document.getElementById('onboardApiKey').value = '';
        }

        // ==================== UI HELPERS ====================
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function switchTenant() {
            currentTenant = document.getElementById('tenantSelector').value;
            displayCustomersList();
            updateAllTenantNames();
            fetchLiveCases();
        }

        function updateAllTenantNames() {
            const customer = customers[currentTenant];
            const name = customer?.name || 'Select Customer';
            
            const elements = ['cisoTenantName', 'analystTenantName', 'managerTenantName', 
                             'incidentTenantName', 'huntingTenantName', 'investigationTenantName',
                             'cloudTenantName', 'integrationTenantName'];
            
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = name;
            });
        }

        function updateLastUpdatedTimes() {
            const now = new Date().toLocaleTimeString();
            document.getElementById('customersLastUpdate').textContent = now;
            document.getElementById('incidentsLastUpdate').textContent = now;
            document.getElementById('criticalLastUpdate').textContent = now;
            document.getElementById('automationLastUpdate').textContent = now;
        }

        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }
    </script>
</body>
</html>